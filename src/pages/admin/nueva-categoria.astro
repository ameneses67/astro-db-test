---
// Render mode
export const prerender = false;

// Astro db
import { db, eq, Category } from "astro:db";

// Ulilities
import { imageFileValidation } from "@libs/utils";

// Layouts
import BaseLayout from "@layouts/BaseLayout.astro";

// Components
import Heading from "@components/ui/Heading.astro";
import Section from "@ui/Section.astro";
import NewCategoryForm from "@components/category/NewCategoryForm.astro";

const categoryRegistered = async (category: string) => {
	const catReg = await db
		.select()
		.from(Category)
		.where(eq(Category.name, category));

	return catReg.length > 0 ? true : false;
};

// Form submission
export const errors = { name: "", description: "", imagePath: "" };
if (Astro.request.method === "POST") {
	try {
		const formData = await Astro.request.formData();
		const name = (formData.get("name") as string).toLowerCase();
		const description = formData.get("description") as string;
		const imagePath = (formData.get("imagePath") as string).toLowerCase();

		if (
			typeof name === "string" &&
			typeof description === "string" &&
			typeof imagePath === "string"
		) {
			if (name.length < 1) {
				errors.name += "Ingresa el nombre de la categoría";
			} else if (await categoryRegistered(name)) {
				errors.name += "Esta categoría ya existe";
			}

			if (description.length < 1) {
				errors.description += "Ingresa la descripción de la categoría";
			}

			if (
				imagePath.length < 1 ||
				imageFileValidation(imagePath as string) === false
			) {
				errors.imagePath += "El formato de la imagen es inválido";
			}

			const hasErrors = Object.values(errors).some((msg) => msg);
			if (!hasErrors) {
				await db.insert(Category).values({ name, description, imagePath });

				return Astro.redirect("/admin/categorias");
			}

			setTimeout(() => {
				errors.name = "";
				errors.description = "";
				errors.imagePath = "";
			}, 3000);
		}
	} catch (error) {
		if (error instanceof Error) {
			console.error(error.message);
		}
	}
}

// Head metadata
const title = "Nueva categoría";
const description = "Crear nueva categoría";
---

<BaseLayout
	{title}
	{description}
>
	<Section>
		<Heading
			tagName="h1"
			size="h1"
			title="Crear categoría"
		>
			Añade una nueva categoría
		</Heading>
		<NewCategoryForm />
	</Section>
</BaseLayout>
